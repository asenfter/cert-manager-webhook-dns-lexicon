name: Create release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g. 1.0.0)"
        required: true
        type: string

jobs:
  create-release:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      packages: write

    env:
      CHART_DIR: deploy/cert-manager-webhook-dns-lexicon
      CHART_NAME: cert-manager-webhook-dns-lexicon

    steps:
      - name: Validate version input
        shell: bash
        run: |
          set -euo pipefail
          VER="${{ inputs.version }}"
          if [[ ! "$VER" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid version: $VER"
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare git identity
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fail if tag already exists
        shell: bash
        run: |
          set -euo pipefail
          VER="${{ inputs.version }}"
          git fetch --tags
          if git rev-parse -q --verify "refs/tags/${VER}" >/dev/null; then
            echo "Tag already exists: ${VER}"
            exit 1
          fi

      - name: Bump Chart.yaml
        shell: bash
        run: |
          set -euo pipefail
          VER="${{ inputs.version }}"
          CHART_YAML="${CHART_DIR}/Chart.yaml"

          sed -i -E "s/^version: .*/version: ${VER}/" "${CHART_YAML}"
          sed -i -E "s/^appVersion: .*/appVersion: \"${VER}\"/" "${CHART_YAML}"

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.15.4

      - name: Helm lint
        run: helm lint "${CHART_DIR}"

      - name: Commit bump back to main
        shell: bash
        run: |
          set -euo pipefail
          VER="${{ inputs.version }}"

          git add "${CHART_DIR}/Chart.yaml"
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "github-actions: bump chart + image to ${VER}"
            git push origin "HEAD:refs/heads/main"
          fi

      - name: Create and push git tag
        shell: bash
        run: |
          set -euo pipefail
          VER="${{ inputs.version }}"

          # ensure tag points to latest main as pushed above
          git fetch origin main
          git checkout main
          git pull --ff-only origin main

          git tag -a "${VER}" -m "Release ${VER}"
          git push origin "${VER}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR (Docker)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          push: true
          context: .
          tags: ghcr.io/${{ github.repository }}:${{ inputs.version }}
          platforms: linux/amd64
          provenance: false
          sbom: false

      - name: Create GitHub release
        uses: ncipollo/release-action@v1
        with:
          generateReleaseNotes: true
          name: Release ${{ inputs.version }}
          tag: ${{ inputs.version }}
